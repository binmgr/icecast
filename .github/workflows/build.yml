name: Build Static Icecast Binaries

on:
  push:
    branches:
      - main
      - master
  schedule:
    # Monthly on 1st at 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  build-linux:
    name: Build for Linux (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            alpine_arch: x86_64
          - arch: aarch64
            alpine_arch: aarch64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Alpine Linux
        uses: jirutka/setup-alpine@v1
        with:
          arch: ${{ matrix.alpine_arch }}
          packages: >
            build-base
            autoconf
            automake
            libtool
            pkgconfig
            git
            curl
            tar
            gzip
            bzip2
            xz
            linux-headers
            autoconf-archive

      - name: Build all dependencies and icecast
        run: |
          set -euo pipefail

          PREFIX="/tmp/icecast-prefix"
          BUILD_DIR="/tmp/icecast-build"
          JOBS=$(nproc)

          mkdir -p "${PREFIX}"

          # Library versions
          ZLIB_VERSION="1.3.1"
          OGG_VERSION="1.3.5"
          VORBIS_VERSION="1.3.7"
          THEORA_VERSION="1.1.1"
          SPEEX_VERSION="1.2.1"
          OPENSSL_VERSION="3.2.1"
          CURL_VERSION="8.5.0"
          LIBXML2_VERSION="2.12.3"
          LIBXSLT_VERSION="1.1.39"
          LIBMAXMINDDB_VERSION="1.11.0"

          export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
          export CFLAGS="-Os -fPIC -static"
          export CXXFLAGS="-Os -fPIC -static"
          export LDFLAGS="-static"

          mkdir -p "${BUILD_DIR}"
          cd "${BUILD_DIR}"

          echo "=========================================="
          echo "Building static dependencies"
          echo "=========================================="

          download_extract() {
            local url="$1"
            local file="$2"
            echo "Downloading ${file}..."
            curl -L -o "${file}" "${url}"
            case "${file}" in
              *.tar.gz|*.tgz) tar xzf "${file}" ;;
              *.tar.xz) tar xJf "${file}" ;;
              *.tar.bz2) tar xjf "${file}" ;;
            esac
          }

          # Build all dependencies
          download_extract "https://zlib.net/zlib-${ZLIB_VERSION}.tar.gz" "zlib.tar.gz"
          cd zlib-${ZLIB_VERSION} && ./configure --prefix="${PREFIX}" --static && make -j${JOBS} && make install && cd "${BUILD_DIR}"

          download_extract "https://downloads.xiph.org/releases/ogg/libogg-${OGG_VERSION}.tar.xz" "libogg.tar.xz"
          cd libogg-${OGG_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static && make -j${JOBS} && make install && cd "${BUILD_DIR}"

          download_extract "https://downloads.xiph.org/releases/vorbis/libvorbis-${VORBIS_VERSION}.tar.xz" "libvorbis.tar.xz"
          cd libvorbis-${VORBIS_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" && make -j${JOBS} && make install && cd "${BUILD_DIR}"

          download_extract "https://downloads.xiph.org/releases/theora/libtheora-${THEORA_VERSION}.tar.bz2" "libtheora.tar.bz2"
          cd libtheora-${THEORA_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" --disable-examples && make -j${JOBS} && make install && cd "${BUILD_DIR}"

          download_extract "https://downloads.xiph.org/releases/speex/speex-${SPEEX_VERSION}.tar.gz" "speex.tar.gz"
          cd speex-${SPEEX_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static && make -j${JOBS} && make install && cd "${BUILD_DIR}"

          git clone --depth 1 https://github.com/rhash/RHash.git
          cd RHash && ./configure --prefix="${PREFIX}" --enable-static --disable-shared && make -j${JOBS} lib-static && make install-lib-static install-lib-headers && cd "${BUILD_DIR}"

          # Create pkg-config file for librhash (it doesn't provide one)
          cat > "${PREFIX}/lib/pkgconfig/librhash.pc" <<EOF
          prefix=${PREFIX}
          exec_prefix=\${prefix}
          libdir=\${exec_prefix}/lib
          includedir=\${prefix}/include

          Name: librhash
          Description: Hash library
          Version: 1.4.4
          Libs: -L\${libdir} -lrhash
          Cflags: -I\${includedir}
          EOF

          download_extract "https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz" "openssl.tar.gz"
          cd openssl-${OPENSSL_VERSION} && ./config --prefix="${PREFIX}" --openssldir="${PREFIX}/ssl" no-shared no-ssl3 no-weak-ssl-ciphers -static && make -j${JOBS} && make install_sw install_ssldirs && cd "${BUILD_DIR}"

          download_extract "https://curl.se/download/curl-${CURL_VERSION}.tar.gz" "curl.tar.gz"
          cd curl-${CURL_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --with-openssl="${PREFIX}" --without-librtmp --without-libssh2 --disable-ldap && make -j${JOBS} && make install && cd "${BUILD_DIR}"

          download_extract "https://download.gnome.org/sources/libxml2/2.12/libxml2-${LIBXML2_VERSION}.tar.xz" "libxml2.tar.xz"
          cd libxml2-${LIBXML2_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --without-python --without-readline --without-lzma --without-zstd --with-zlib="${PREFIX}" && make -j${JOBS} && make install && cd "${BUILD_DIR}"

          download_extract "https://download.gnome.org/sources/libxslt/1.1/libxslt-${LIBXSLT_VERSION}.tar.xz" "libxslt.tar.xz"
          cd libxslt-${LIBXSLT_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --without-python --with-libxml-prefix="${PREFIX}" && make -j${JOBS} && make install && cd "${BUILD_DIR}"

          download_extract "https://github.com/maxmind/libmaxminddb/releases/download/${LIBMAXMINDDB_VERSION}/libmaxminddb-${LIBMAXMINDDB_VERSION}.tar.gz" "libmaxminddb.tar.gz"
          cd libmaxminddb-${LIBMAXMINDDB_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static && make -j${JOBS} && make install && cd "${BUILD_DIR}"

          # Build libigloo with pthread flags (musl has pthread built into libc)
          git clone --depth 1 https://gitlab.xiph.org/xiph/icecast-libigloo.git
          cd icecast-libigloo && autoreconf -fi && CFLAGS="-Os -fPIC -pthread" LDFLAGS="-pthread" PTHREAD_CFLAGS="-pthread" PTHREAD_LIBS="-pthread" ./configure --prefix="${PREFIX}" --disable-shared --enable-static && make -j${JOBS} CFLAGS="-Os -fPIC -static" LDFLAGS="-static" && make install && cd "${BUILD_DIR}"

          echo "=========================================="
          echo "Building icecast"
          echo "=========================================="

          cd "${BUILD_DIR}"
          git clone --recursive https://github.com/xiph/Icecast-Server.git
          cd Icecast-Server

          VERSION=$(sed -n 's/^AC_INIT(\[Icecast\], \[\([0-9.]*\)\].*/\1/p' configure.ac || echo "2.5.0")
          echo "${VERSION}" > VERSION.txt

          export CFLAGS="-Os -I${PREFIX}/include"
          export LDFLAGS="-L${PREFIX}/lib"

          autoreconf -fi

          ./configure \
            --prefix=/usr \
            --sysconfdir=/etc \
            --enable-yp \
            --enable-ipv6 \
            --with-curl-config="${PREFIX}/bin/curl-config" \
            --with-xml-config="${PREFIX}/bin/xml2-config" \
            --with-xslt-config="${PREFIX}/bin/xslt-config" \
            --with-ogg="${PREFIX}" \
            --with-vorbis="${PREFIX}" \
            --with-theora="${PREFIX}" \
            --with-speex="${PREFIX}" \
            --with-openssl="${PREFIX}" \
            --with-libmaxminddb="${PREFIX}"

          make -j${JOBS}
          mv src/icecast src/icecast-bin
          strip src/icecast-bin

          echo "Build complete - Version: ${VERSION}"
          ./src/icecast-bin -v || true
          ldd src/icecast-bin || echo "Static binary"

        shell: alpine.sh {0}

      - name: Extract version and create artifacts
        run: |
          VERSION=$(cat /tmp/icecast-build/Icecast-Server/VERSION.txt)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          cd /tmp/icecast-build/Icecast-Server/src
          ARCH="${{ matrix.arch }}"
          ARCH="${ARCH%-musl}"
          mv icecast-bin icecast-linux-${ARCH}
          chmod +x icecast-linux-${ARCH}
        shell: alpine.sh {0}
        id: version

      - name: Create source archive
        if: matrix.arch == 'x86_64'
        run: |
          cd /tmp/icecast-build/Icecast-Server
          VERSION=$(cat VERSION.txt)
          rm -rf .git .gitignore .github
          cd /tmp/icecast-build
          tar czf icecast-${VERSION}-src.tar.gz Icecast-Server/
        shell: alpine.sh {0}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: icecast-linux-${{ matrix.arch }}
          path: /tmp/icecast-build/Icecast-Server/src/icecast-linux-${{ matrix.arch }}

      - name: Upload source archive
        if: matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: source-archive
          path: /tmp/icecast-build/icecast-*-src.tar.gz

      - name: Upload version
        uses: actions/upload-artifact@v4
        with:
          name: version-linux-${{ matrix.arch }}
          path: /tmp/icecast-build/Icecast-Server/VERSION.txt

  # Note: macOS, Windows, and FreeBSD builds would follow similar pattern
  # For now, focusing on Linux builds which are most critical

  create-release:
    name: Create Release
    needs: [build-linux]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version
        id: version
        run: |
          VERSION=$(cat artifacts/version-linux-x86_64/VERSION.txt)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Organize artifacts
        run: |
          mkdir -p release
          find artifacts -name 'icecast-*' -type f -exec cp {} release/ \;
          ls -lh release/

      - name: Create checksums
        run: |
          cd release
          sha256sum icecast-* > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Delete existing release
        run: |
          if gh release view "v${{ steps.version.outputs.version }}" &> /dev/null; then
            echo "Deleting existing release v${{ steps.version.outputs.version }}"
            gh release delete "v${{ steps.version.outputs.version }}" -y
            git push --delete origin "v${{ steps.version.outputs.version }}" || true
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Icecast v${{ steps.version.outputs.version }}
          body: |
            # Icecast v${{ steps.version.outputs.version }} - Static Binaries for Linux

            Truly static binaries for Icecast streaming server with all features enabled.

            ## Features

            ✅ XML configuration (libxml2, libxslt)
            ✅ Ogg Vorbis streaming
            ✅ Theora video streaming
            ✅ Speex codec support
            ✅ TLS/SSL support (OpenSSL)
            ✅ YP directory support (libcurl)
            ✅ GeoIP location lookups (libmaxminddb)
            ✅ IPv6 support
            ✅ Authentication and admin interface

            ## Downloads

            ### Linux (fully static with musl)
            - [icecast-linux-x86_64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/icecast-linux-x86_64)
            - [icecast-linux-aarch64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/icecast-linux-aarch64)

            ### Source Archive
            - [icecast-${{ steps.version.outputs.version }}-src.tar.gz](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/icecast-${{ steps.version.outputs.version }}-src.tar.gz)

            ## Verification

            [SHA256SUMS.txt](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/SHA256SUMS.txt)

            ```bash
            sha256sum -c SHA256SUMS.txt --ignore-missing
            ```

            ## Quick Start

            ```bash
            # Download
            wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/icecast-linux-x86_64

            # Make executable
            chmod +x icecast-linux-x86_64

            # Rename
            mv icecast-linux-x86_64 icecast

            # Run
            ./icecast -c /etc/icecast.xml
            ```

            ---

            **Source**: [xiph/Icecast-Server](https://github.com/xiph/Icecast-Server)
          files: release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
